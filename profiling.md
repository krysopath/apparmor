# generate an AppArmor profile for an example script
## get the utils
```
sudo apt install apparmor-utils
```
## generate profile stub for a process

First start the profiler:

```
cd src/
$ sudo aa-genprof app.sh
[...]
```

> This monitors the audit log events apparmor for the specified process.

Second start the process in a second terminal:

```
~/src/apparmorify/src $ ./app.sh
just a naive example
+ mkdir -p data/
+ ./app.sh: line 5: /usr/bin/mkdir: Permission denied
+ + touch data/cached-assets
+ ./app.sh: line 6: /usr/bin/touch: Permission denied
+ + rm data/cached-assets
+ ./app.sh: line 7: /usr/bin/rm: Permission denied
```
> Since the default profile we inherit from is full deny, our innocent script got no permission at all yet.


> You are entering a loop in which you trigger all code branches of the application and react to the events in `aa-genprof`


## profiling loop

After the first execution go back to the terminal with `aa-genprof` and hit `S` to scan the log for new events.

The new events were generated by our first execution. The util will now iterate over all ACL related actions of `app.sh` and ask your for policy.


From many options that can be granted to you, these three are common and generic:

- Inherit: A `ix` policy causes the executed binary to inherit permissions from the parent profile.

- Child: `Cx` policy, that requires a sub-profile within the parent profile and rules must be separately generated.

- Deny: `deny` policy causes the parents access to the resource be denied.


For `app.sh` the first events looked like this:
```
Reading log entries from /var/log/syslog.
Updating AppArmor profiles in /etc/apparmor.d.

Profile:  /home/gve/src/apparmorify/src/app.sh
Execute:  /usr/bin/mkdir
Severity: unknown

(I)nherit / (C)hild / (N)amed / (X) ix On / (D)eny / Abo(r)t / (F)inish

Profile:  /home/gve/src/apparmorify/src/app.sh
Execute:  /usr/bin/touch
Severity: 3

(I)nherit / (C)hild / (N)amed / (X) ix On / (D)eny / Abo(r)t / (F)inish

Profile:  /home/gve/src/apparmorify/src/app.sh
Execute:  /usr/bin/rm
Severity: unknown

(I)nherit / (C)hild / (N)amed / (X) ix On / (D)eny / Abo(r)t / (F)inish
Enforce-mode changes:

Profile:  /home/gve/src/apparmorify/src/app.sh
Path:     /dev/tty
New Mode: rw
Severity: 9

 [1 - #include <abstractions/consoles>]
  2 - /dev/tty rw,
(A)llow / [(D)eny] / (I)gnore / (G)lob / Glob with (E)xtension / (N)ew / Audi(t) / Abo(r)t / (F)inish
Adding #include <abstractions/consoles> to profile.

Profile:  /home/gve/src/apparmorify/src/app.sh
Path:     /etc/terminfo/s/st-256color
New Mode: r
Severity: unknown

 [1 - /etc/terminfo/s/st-256color r,]
(A)llow / [(D)eny] / (I)gnore / (G)lob / Glob with (E)xtension / (N)ew / Audi(t) / Abo(r)t / (F)inish
Adding /etc/terminfo/s/st-256color r, to profile.

= Changed Local Profiles =

The following local profiles were changed. Would you like to save them?

 [1 - /home/gve/src/apparmorify/src/app.sh]
(S)ave Changes / Save Selec(t)ed Profile / [(V)iew Changes] / View Changes b/w (C)lean profiles / Abo(r)t
```

>  When aa-genprof shows "= Changed Local Profiles =", you can hit the `S` button and rexecute `app.sh` to continue in other code branches

I chose to `ix` inherit the permissions largely from parent process. Inheritance of permissions in process trees is the fundamental unix security model. However depending on application or operating system configuration you want to audit each event in its context for risk implication.



And the next execution of `app.sh` was erroring like this:

```
~/src/apparmorify/src $ ./app.sh
+ just a naive example
+ + mkdir -p data/
+ + touch data/cached-assets
+ touch: cannot touch 'data/cached-assets': Permission denied
+ + rm data/cached-assets
+ rm: cannot remove 'data/cached-assets': No such file or directory
```

> Note how this iteration was about two file access permissions errors

Now hit `S` for scan again in the `aa-prof` process and see these lines:

```
Reading log entries from /var/log/syslog.
Enforce-mode changes:

Profile:  /home/gve/src/apparmorify/src/app.sh
Path:     /home/gve/src/apparmorify/src/data/cached-assets
New Mode: owner w
Severity: 6

 [1 - owner /home/*/src/apparmorify/src/data/cached-assets w,]
  2 - owner /home/gve/src/apparmorify/src/data/cached-assets w,
(A)llow / [(D)eny] / (I)gnore / (G)lob / Glob with (E)xtension / (N)ew / Audi(t) / (O)wner permissions off / Abo(r)t / (F)inish
Adding owner /home/*/src/apparmorify/src/data/cached-assets w, to profile.
```


> Here we had two execution errors in `app.sh` but only one audit event as the second error was caused by the first one.

> as `app.sh` depends on its `data/cached-assets` directory access and file writing for execution we easily inherit from parent and create a `ix` prefixed rule

A third execution yields successful `app.sh`:

```
~/src/apparmorify/src $ ./app.sh
+ just a naive example
+ + mkdir -p data/
+ + touch data/cached-assets
+ + rm data/cached-assets
+
```

## confirmation

Modify `app.sh` to do something a hacker would want to happen:
```
echo 'nc -nvlp 31337 -e /bin/bash' >> app.sh
```

and execute `app.sh`:

```
 $ ./app.sh
 just a naive example
 + mkdir -p data/
 + + touch data/cached-assets
 + + rm data/cached-assets
 + + nc -nvlp 31337 -e /bin/bash
 + ./app.sh: line 8: /usr/bin/nc: Permission denied
 +
```
